- [#C] #SunnSaaS Los análisis deberían tener otro estado que fuera el de esperando postprocesamiento, una vez sus tasks han terminado
- [#C] Datos de importación / exportación SunnSaaS en 10-desktop, procesar
- DONE #Reunión Conversación con [[Manolo Quero]]
  collapsed:: true
  :LOGBOOK:
  CLOCK: [2023-03-15 Wed 12:30:00]--[2023-03-15 Wed 13:00:00] =>  00:30:00
  :END:
  - Spellings
  - Ordenador Rocío semana que viene
  - Bajada del campo
  - Actualización tests/ API...
  - Actualización Juanma, Pepe
  - Bluesolar tests con límites y topografía
  - Entendimiento python + fortran
  - Front-end: fotos e imágenes
  - Botón para hel field y otro para efficiencia heliostatos
  - Spelling errors
  - Opción DNI diseño
  - Steam UC
  - Visualización CSP visualiser: barra lateral y torre
- [#C] Visualización CSP visualiser: barra lateral y torre, plantear
- LATER [#A] #IT Migración al ordenador de [[Rocío Mingorance]] #T/3
  SCHEDULED: <2023-04-24 Mon>
  collapsed:: true
  :LOGBOOK:
  CLOCK: [2023-04-17 Mon 08:40:00]--[2023-04-17 Mon 09:00:00] =>  00:20:00
  CLOCK: [2023-04-20 Thu 09:33:23]--[2023-04-20 Thu 10:13:47] =>  00:40:24
  CLOCK: [2023-04-24 Mon 09:18:22]--[2023-04-24 Mon 11:16:13] =>  01:57:51
  :END:
  - [[2023/04/17 Monday]]
    - No arranca. Los disipadores se disparan y se apagan a los segundos. No llega a arrancar el SO. Hemos hablado con [[Rodrigo UPI]]. Que probemos quitando y poniendo la memoria. Esperando a tener los guantes antiestáticos.
  - [[2023/04/20 Thursday]]
    - Ha arrancado reposicionando la memoria. Se le ha reinstalado un Ubuntu 22.04, todo bien.
    - Comenzar la migración a esa máquina.
  - [[2023/04/24 Monday]]
    - [#A] Migrando, seguir.
    - Seguir confeccionando las instrucciones en [[L/toolsresearch]]/Ubuntu. También tenemos un TXT en Desktop para ir actualizando las instrucciones de configuración de un nuevo Linux Desktop.
- DONE #SunnSaaS [[Python]] / [[Fortran]]: experimento de comunicación
  collapsed:: true
  :LOGBOOK:
  CLOCK: [2023-03-15 Wed 19:02:51]--[2023-03-15 Wed 19:11:23] =>  00:08:32
  CLOCK: [2023-03-29 Wed 14:00:57]--[2023-03-29 Wed 14:33:23] =>  00:32:26
  CLOCK: [2023-03-29 Wed 16:25:19]--[2023-03-29 Wed 16:53:09] =>  00:27:50
  CLOCK: [2023-03-29 Wed 16:58:54]--[2023-03-29 Wed 18:53:58] =>  01:55:04
  CLOCK: [2023-03-29 Wed 19:21:57]--[2023-03-29 Wed 19:54:18] =>  00:32:21
  CLOCK: [2023-04-03 Mon 18:15:00]--[2023-04-03 Mon 19:00:00] =>  00:45:00
  CLOCK: [2023-04-03 Mon 19:33:11]--[2023-04-03 Mon 19:38:34] =>  00:05:23
  CLOCK: [2023-04-04 Tue 09:37:16]--[2023-04-04 Tue 10:02:04] =>  00:24:48
  CLOCK: [2023-04-04 Tue 10:42:30]--[2023-04-04 Tue 12:19:02] =>  01:36:32
  CLOCK: [2023-04-04 Tue 12:20:04]--[2023-04-04 Tue 14:10:17] =>  01:50:13
  CLOCK: [2023-04-05 Wed 11:13:34]--[2023-04-05 Wed 11:39:08] =>  00:25:34
  CLOCK: [2023-04-05 Wed 12:11:08]--[2023-04-05 Wed 14:51:03] =>  02:39:55
  CLOCK: [2023-04-10 Mon 11:50:42]--[2023-04-10 Mon 14:33:07] =>  02:42:25
  CLOCK: [2023-04-10 Mon 17:30:38]--[2023-04-10 Mon 18:17:22] =>  00:46:44
  CLOCK: [2023-04-10 Mon 19:21:19]--[2023-04-10 Mon 19:23:03] =>  00:01:44
  CLOCK: [2023-04-11 Tue 10:01:27]--[2023-04-11 Tue 11:00:22] =>  00:58:55
  CLOCK: [2023-04-11 Tue 11:31:21]--[2023-04-11 Tue 13:55:07] =>  02:23:46
  CLOCK: [2023-04-11 Tue 14:08:36]--[2023-04-11 Tue 14:34:39] =>  00:26:03
  CLOCK: [2023-04-11 Tue 17:39:24]--[2023-04-11 Tue 19:58:57] =>  02:19:33
  CLOCK: [2023-04-12 Wed 09:46:33]--[2023-04-12 Wed 10:13:00] =>  00:26:27
  CLOCK: [2023-04-12 Wed 10:26:14]--[2023-04-12 Wed 10:32:03] =>  00:05:49
  CLOCK: [2023-04-12 Wed 11:56:30]--[2023-04-12 Wed 14:25:17] =>  02:28:47
  CLOCK: [2023-04-13 Thu 13:06:16]--[2023-04-13 Thu 14:31:35] =>  01:25:19
  CLOCK: [2023-04-13 Thu 17:20:48]--[2023-04-13 Thu 17:20:59] =>  00:00:11
  CLOCK: [2023-04-13 Thu 17:30:46]--[2023-04-13 Thu 18:57:09] =>  01:26:23
  CLOCK: [2023-04-13 Thu 19:44:46]--[2023-04-13 Thu 19:49:17] =>  00:04:31
  CLOCK: [2023-04-13 Thu 19:49:20]--[2023-04-13 Thu 20:01:04] =>  00:11:44
  :END:
  - Notas preliminares
    collapsed:: true
    - Posibilidad técnica muy importante: yo programaría en [[Python]] y haría funciones en Python que se incrustarían en una librería [[Fortran]] que sería proporcionada a esta gente. [Calling Python from Fortran (not the other way around) | Noah D. Brenowitz](https://www.noahbrenowitz.com/post/calling-fortran-from-python/). Tenemos varios links en Raindrop con la tag **Fortran**, revisar
    - Referencias
      - [Calling Python from Fortran (not the other way around) | Noah D. Brenowitz](https://www.noahbrenowitz.com/post/calling-fortran-from-python/)
      - [GitHub - nbren12/call_py_fort: Call python from fortran](https://github.com/nbren12/call_py_fort)
      - [GitHub - ylikx/forpy: Forpy - use Python from Fortran](https://github.com/ylikx/forpy)
  - [[2023/03/29 Wednesday]]
    collapsed:: true
    - Realizadas las primera pruebas, con éxito.
    - La librería **[Forpy](https://github.com/ylikx/forpy)** parece ser la vía más prometedora hasta ahora.
    - Se ha modificado, en la rama **[[G/sunnsaas/sunnsaas_v1]]/feature/user_review**, la definición de la imagen Docker base para la compilación Fortran y para el componente worker situada en **docker/010_fortran_worker_dev_image/010-docker_image-sunnsaas-worker-dev**. Esta imagen [[sunnsaas-worker-dev]] se usa como base para el componente [[worker]] y en [[G/sunntics-core-restricted/monolithic-core-algorithms]] para las tareas de compilación.
      collapsed:: true
      - Se le ha añadido **sudo** para el usuario 1000, el **pip** y la posibilidad de instalar paquetes pip.
      - Se ha modernizado algo.
      - Sin embargo, no estamos seguros de que estas modificaciones sean necesarias y nos da miedo romper la compatibilidad con el componente [[worker]] y los procesos de compilación Fortran. Por lo tanto, cuando se desarrolle la prueba de concepto de más abajo veremos si es necesario mantenerlas o se revierte a la versión anterior.
    - Para alojar el test de integración, y posiblemente los desarrollos futuros Python - Fortran, se ha creado un repositorio en [[GitHub]] llamado [[G/sunntics-core-restricted/fortran_python_dev]]. Contiene la definición modificada de la imagen Docker **010-docker_image-sunnsaas-worker-dev** y el código de ejemplo y de build de [[Forpy]]. Hay que hacer lo siguiente:
      collapsed:: true
      - Tenemos el repo [[G/sunnsaas/sunnsaas_v1]] sin consolidar a la espera de realizar este paso y restaurar la definición de la imagen [[sunnsaas-worker-dev]] a su definición original, salvo modernizaciones muy obvias.
        collapsed:: true
        - Arreglado ya.
      - Crear una nueva imagen Docker Python + Fortran llamada **fortran-python-dev** para esta tarea. Eliminar todo lo que suene a Node heredado de la imagen anterior. Actualmente, la imagen [[sunnsaas-worker-dev]], donde los desarrollos deben correr, está basada en **ubuntu:20.04** y la versión Python es la **3.8.10**. Es del 2019 y termina soporte el año que viene, habría que cambiarla. Está en estado de desarrollo **security**. La última es la 3.11 del 2022 y con final de soporte el 2027.
        collapsed:: true
        - Hecho el [[2023/04/03 Monday]].
      - Quizás lo ideal sería hacer un clon de la imagen de desarrollo Python que está en el repo [[G/docker/python]] con esta versión de Python y añadirle desde paquetería el Fortran correspondiente a la versión que tiene la image [[sunnsaas-worker-dev]], y trabajar a partir de ahí.
    - [[Forpy]] no se instala como paquete **pip**. Forpy es un módulo Fortran en forma **.o** que simplemente se importa en un programa Fortran y se proporciona a **gfortran** como una dependencia:
      collapsed:: true
      - ```shell
        gfortran intro_to_forpy.F90 forpy_mod.o `python3-config --ldflags --embed`
        ```
    - El objetivo a conseguir es el siguiente:
      collapsed:: true
      - crear un módulo Python que se publique en Wheels;
      - crear, gracias a [[Forpy]], un wrapper Fortran que importe este módulo y exponga su API;
      - buscar el mejor mecanismo para compilar Python + Fortran y generar un módulo Fortran, una librería o bien directamente un **.o**.
      - utilizar el módulo o la librería en un programa 100% Fortran.
    - Dudas
      collapsed:: true
      - ¿Precisa la imagen objetivo final de compilación de programas Fortran que usan [[Manolo Quero]] y [[Rocío Mingorance]] tener instalado Python, pip y las librerías Python que se usen, o la compilación Forpy "embebe" de alguna forma todo en algo sin dependencias?
      - ¿Que hay de la imagen [[sunnsaas-worker-dev]]? ¿Necesita las dependencias o puede ir sin ellas igualmente una vez los binarios Fortran están construidos?
  - [[2023/04/03 Monday]]
    collapsed:: true
    - Retomando la creación de la imagen [[Docker]] **fortran-python-dev** en [[G/sunntics-core-restricted/fortran_python_dev]]. Basamos la imagen en **Ubuntu 22.04**.
    - Hemos revisado y creado la imagen **fortran-python-dev**, hacer un esqueleto de proyecto completo. Lleva **Python 3.10.6**, **pip 22.0.2** e **ipython 8.12.0**.
  - [[2023/04/04 Tuesday]]
    collapsed:: true
    - Tenemos ya un prototipo de la imagen **fortran-python-dev**.
    - Hemos avanzado bastante en el entendimiento de muchas cosas, todo está en la documentación de [[G/sunntics-core-restricted/fortran_python_dev]].
  - [[2023/04/05 Wednesday]]
    collapsed:: true
    - Investigando las bondades de [[Visual Studio Code]] como entorno [[Fortran]]. Se ha conseguido integrar todo en [[Dev Containers]] con depuración por breakpoints, bastante útil.
  - [[2023/04/10 Monday]]
    collapsed:: true
    - Documentado todo lo aprendido el día anterior sobre configuración de entorno en [[Visual Studio Code]] , todo en [[L/toolsresearch]].
    - Hemos dejado un buen ejemplo de cómo configurar un entorno [[Fortran]] con [[Visual Studio Code]] en [[G/sunntics-core-restricted/fortran_python_dev]], incluyendo cómo hacer [[makefile]]s apañados.
    - Trabajando en **020-forpy_wrapper_sample_module**, creando un módulo que encapsula las llamadas al módulo Python, va bastante bien. Seguir aquí.
  - [[2023/04/11 Tuesday]]
    collapsed:: true
    - Hemos llegado a un buen punto en el que podemos crear una función en [[Python]] que devuelve un diccionario que mapeamos a un tipo definido por el usuario en Fortran.
    - Tenemos que ver cómo devolver NDARRAY y como crear NDARRAY desde Fortran.
  - [[2023/04/12 Wednesday]]
    collapsed:: true
    - Comprobado: si el módulo Python utiliza dependencias externas, como Numpy, el contenedor que compila el programa Fortran que lo usa con Forpy necesita también tener instalada la dependencia con pip.
    - Otra lección: una vez que se llama a **forpy_initialize()** se crea un entorno Python. Cuando se llama a **forpy_finalize** ese entorno se rompe. En un mismo programa, no se puede volver a recrear ese entorno. Por lo tanto, un programa que use el módulo debe llamar primero a **forpy_initialize()** y terminar con **forpy_finalize**. Si intenta volver a llamar a **forpy_initialize()** peta con un SEGFAULT. Por lo tanto, un programa Fortran sólo puede tener una llamada **forpy_initalize()** y otra **forpy_finalize()**:
      collapsed:: true
      - ```Fortran
        program p
        
            ! Load modules
            use forpy_mod
            ! Two Python wrapper modules
            use pyfortestwrapper_mod
            use pyfortestaddwrapper_mod
        
            implicit none
        
            ! Initialize Forpy environment
            ierror = forpy_initialize()
            Print*, "Forpy inialization error code ", ierror
        
        	! Test functions from both Python wrappers here
        
            ! Finalize Forpy
            call forpy_finalize
        
        end program p
        
        ```
    - Hemos creado un nuevo módulo Python para ver cómo interaccionan varios wrappers en un mismo programa. Se ha creado el WP **025** en [[G/sunntics-core-restricted/fortran_python_dev]]. Su wrapper está junto al otro en **030**. Sin embargo, Fortran parece no tener una forma de evitar conflictos de nombres con funciones que vienen de distintos módulos, así que hay que establecer la diferenciación semánticamente, lo que es un rollo.
    - Finalmente, todo va bien. Abriendo y cerrando el entorno [[Forpy]] únicamente una vez por programa se pueden utilizar funciones de los dos módulos sin problemas.
    - Por ahora todo bien, estamos intentando importar en Fortran el resultado de una función Python que devuelva una lista (después lo intentaremos con un NDARRAY), pero por ahora nada, no parece que podamos convertir la salida de la función en una lista de Forpy. Se ha reportado el asunto en el GitHub de Forpy y la respuesta ha sido útil.
  - [[2023/04/13 Thursday]]
    collapsed:: true
    - Recibida respuesta en los foros de [[GitHub]], aclarado todo con el uso, muy útil, de la función **err_print**. El error de ayer estaba en que se estaba llamando a la función Python con más parámetros de la cuenta.
    - Extraordinarios resultados, ya podemos trabajar con **listas** y arrays **ndarray** que vienen desde Python. En la documentación de [[Forpy]] viene muy bien explicado cómo construir una **ndarray** en Fortran para pasársela a Python, por lo que no vamos a hacerlo. Creo que ya cubrimos todos los casos de uso.
    - Ahora ya lo único que queda por probar es el uso del módulo en un entorno no preparado con Python de salida, con la imagen Fortran que usamos en producción: **[[registry.gitlab.com]]/sunnsaas/sunnsaas_v1/sunnsaas-worker-dev**.
    - Las pruebas se han realizado con éxito en [[G/sunntics-core-restricted/fortran_python_dev/040-test_fortran_env]].
    - Con esto terminamos este largo experimento.
- [#A] #SunnSaaS/Frontend Fotos e imágenes
- [#A] #SunnSaaS/API Despliegue automático del algoritmo en caliente: hacer algo para que [[Manolo Quero]] pueda subir binarios a una instancia automáticamente. Esto requeriría que SunnSaaS avisara de qué versión del algoritmo se está utilizando. Utilizaríamos una instancia para ello.
- [#C] #SunnSaaS/API Implementar la opción de que cuando se termine un análisis se hagan unas pruebas de calidad.